name: PR Version Update and Validation Workflow

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  validate_pr_title:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install jq for JSON Processing
        run: sudo apt-get install -y jq

      - name: Validate Pull Request Title
        id: validate_title
        run: |
          pr_title=$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")
          if [[ $pr_title =~ Release ]]; then
            echo "The Pull Request contains the keyword 'Release'. Stopping process."
            exit 0
          elif [[ ! $pr_title =~ (Majeur|Mineur|Patch) ]]; then
            echo "The Pull Request title does not contain the keywords 'Majeur', 'Mineur', or 'Patch'."
            echo "Please include one of these keywords in the title of your Pull Request."
            exit 1
          fi
          echo "::set-output name=title::$pr_title"

  update_version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq for JSON Processing
        run: sudo apt-get install -y jq

      - name: Fetch All Branches
        run: git fetch --all

      - name: Checkout Pull Request Branch
        run: git checkout ${{ github.head_ref }}

      - name: Extract Version from Last PR Title
        id: extract_version
        run: |
          response=$(curl -s -H "Authorization: token ${{ secrets.API_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/pulls?state=closed&sort=updated&direction=desc&per_page=100")
          latest_pr_titles=$(echo "$response" | jq -r '.[].title')
          version=""
          while read -r title; do
            version=$(echo "$title" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
            [[ ! -z "$version" ]] && break
          done <<< "$latest_pr_titles"
          [[ -z "$version" ]] && version="1.0.0"
          echo "::set-output name=version::$version"

      - name: Extract Current PR Title
        id: pr_info
        run: |
          pr_title=$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")
          echo "::set-output name=title::$pr_title"

      - name: Update Version Based on PR Title
        id: update_version
        run: |
          title="${{ steps.pr_info.outputs.title }}"
          version="${{ steps.extract_version.outputs.version }}"
          if [[ $title == *"Majeur"* ]]; then
              version=$(echo $version | awk -F. '{$1++; $2=0; $3=0} 1' OFS=.)
          elif [[ $title == *"Mineur"* ]]; then
              version=$(echo $version | awk -F. '{$2++; $3=0} 1' OFS=.)
          elif [[ $title == *"Patch"* ]]; then
              version=$(echo $version | awk -F. '{$3++} 1' OFS=.)
          fi
          new_title="${version} - ${title}"
          echo "::set-output name=new_title::$new_title"
          echo "::set-output name=new_version::$version"

      - name: Update Pull Request Title
        run: |
          new_title="${{ steps.update_version.outputs.new_title }}"
          pr_number=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"title\": \"$new_title\"}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${pr_number}"

      - name: Update composer.json with New Version
        run: |
          version="${{ steps.update_version.outputs.new_version }}"
          if [ ! -f composer.json ]; then
            echo "composer.json not found!"
            exit 1
          fi
          jq --arg version "$version" '.version = $version' composer.json > tmp.$$.json && mv tmp.$$.json composer.json
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add composer.json
          git commit -m "Update version to $version in composer.json"
          git push origin "HEAD:${{ github.head_ref }}"
